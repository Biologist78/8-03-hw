# Домашнее задание к занятию `«Основы Terraform. Yandex Cloud»` - `Васильев Николай`

------

### Цели задания

1. Создать свои ресурсы в облаке Yandex Cloud с помощью Terraform.
2. Освоить работу с переменными Terraform.


### Чек-лист готовности к домашнему заданию

1. Зарегистрирован аккаунт в Yandex Cloud. Использован промокод на грант.
2. Установлен инструмент Yandex CLI.
3. Исходный код для выполнения задания расположен в директории [**02/src**](https://github.com/netology-code/ter-homeworks/tree/main/02/src).


### Задание 0

1. Ознакомьтесь с [документацией к security-groups в Yandex Cloud](https://cloud.yandex.ru/docs/vpc/concepts/security-groups?from=int-console-help-center-or-nav). 
Этот функционал понадобится к следующей лекции.

------
### Внимание!! Обязательно предоставляем на проверку получившийся код в виде ссылки на ваш github-репозиторий!
------

### Задание 1
В качестве ответа всегда полностью прикладывайте ваш terraform-код в git.
Убедитесь что ваша версия **Terraform** ~>1.8.4

1. Изучите проект. В файле variables.tf объявлены переменные для Yandex provider.
2. Создайте сервисный аккаунт и ключ. [service_account_key_file](https://terraform-provider.yandexcloud.net).
4. Сгенерируйте новый или используйте свой текущий ssh-ключ. Запишите его открытую(public) часть в переменную **vms_ssh_public_root_key**.
>![img](/img/Снимок%20экрана%202024-10-01%20224051.png)
5. Инициализируйте проект, выполните код. Исправьте намеренно допущенные синтаксические ошибки. Ищите внимательно, посимвольно. Ответьте, в чём заключается их суть.
>![img](/img/Снимок%20экрана%202024-10-02%20002209.png)
Не нашел авторизованный ключ в домашней директории.
Поменял имя, путь оставил тот же.

>![img](/img/Снимок%20экрана%202024-10-02%20004343.png)
Поменял platform_id на standar<u>d</u>-`v2` самая минимальная платформа, в v4 не существует.
>
>Изменил cores на 2, т.к. это минимально возможное количество ядер процессоров в YC.

7. Подключитесь к консоли ВМ через ssh и выполните команду ``` curl ifconfig.me```.
Примечание: К OS ubuntu "out of a box, те из коробки" необходимо подключаться под пользователем ubuntu: ```"ssh ubuntu@vm_ip_address"```. Предварительно убедитесь, что ваш ключ добавлен в ssh-агент: ```eval $(ssh-agent) && ssh-add``` Вы познакомитесь с тем как при создании ВМ создать своего пользователя в блоке metadata в следующей лекции.;
8. Ответьте, как в процессе обучения могут пригодиться параметры ```preemptible = true``` и ```core_fraction=5``` в параметрах ВМ.
>Позволяют экономить средства на облаке.
> * Параметр `preemptible` отвечает за возможность остановки машины в любой момент:
>     * Из-за нехватки ресурсов в зоне доступности.
>     * По истеченю 24-х часов.
> * Параметр `core_fraction` устанавливает базовый уровень производительности процессора в процентах.

В качестве решения приложите:

- скриншот ЛК Yandex Cloud с созданной ВМ, где видно внешний ip-адрес;
![2024-10-02_01-26-16.png](/img/2024-10-02_01-26-16.png)
- скриншот консоли, curl должен отобразить тот же внешний ip-адрес;
![img](/img/Снимок%20экрана%202024-10-02%20012652.png)
- ответы на вопросы.


### Задание 2

1. Замените все хардкод-**значения** для ресурсов **yandex_compute_image** и **yandex_compute_instance** на **отдельные** переменные. К названиям переменных ВМ добавьте в начало префикс **vm_web_** .  Пример: **vm_web_name**.
2. Объявите нужные переменные в файле variables.tf, обязательно указывайте тип переменной. Заполните их **default** прежними значениями из main.tf. 
3. Проверьте terraform plan. Изменений быть не должно. 

| ![img](/img/Снимок%20экрана%202024-10-02%20035552.png) | ![img](/img/Снимок%20экрана%202024-10-02%20035352.png) |
|:-------------------------------------------:|:-------------------------------------------:|
![img](/img/Снимок%20экрана%202024-10-02%20034441.png)
### Задание 3

1. Создайте в корне проекта файл 'vms_platform.tf' . Перенесите в него все переменные первой ВМ.
2. Скопируйте блок ресурса и создайте с его помощью вторую ВМ в файле main.tf: **"netology-develop-platform-db"** ,  ```cores  = 2, memory = 2, core_fraction = 20```. Объявите её переменные с префиксом **vm_db_** в том же файле ('vms_platform.tf').  ВМ должна работать в зоне "ru-central1-b"
3. Примените изменения.
![img](/img/Снимок%20экрана%202024-10-02%20054620.png)
![2024-10-02_01-26-16.png](/img/2024-10-02_05-47-16.png)
### Задание 4

1. Объявите в файле outputs.tf **один** output , содержащий: instance_name, external_ip, fqdn для каждой из ВМ в удобном лично для вас формате.(без хардкода!!!)
2. Примените изменения.
```terraform
output "YC_VM" {
  value = [
    { vm_web = ["Name Machine: ${yandex_compute_instance.platform.name}","Public ip: ${yandex_compute_instance.platform.network_interface[0].nat_ip_address}","FQDN: ${yandex_compute_instance.platform.fqdn}"] },
    { vm_db = ["Name Machine: ${yandex_compute_instance.db_platform.name}","Public ip: ${yandex_compute_instance.db_platform.network_interface[0].nat_ip_address}","FQDN: ${yandex_compute_instance.db_platform.fqdn}"] }
  ]
}
```
В качестве решения приложите вывод значений ip-адресов команды ```terraform output```.
![img](/img/Снимок%20экрана%202024-10-02%20072734.png)

### Задание 5

1. В файле locals.tf опишите в **одном** local-блоке имя каждой ВМ, используйте интерполяцию ${..} с НЕСКОЛЬКИМИ переменными по примеру из лекции.
2. Замените переменные внутри ресурса ВМ на созданные вами local-переменные.
3. Примените изменения.
```terraform
locals {
  name1 = "netology"
  name2 = "develop"
  name3 = "platform"
  name4 = "db"
  name5 = "web"
  vm_db_name = "${local.name1} - ${local.name2} - ${local.name3} - ${local.name4}"
  vm_web_name = "${local.name1} - ${local.name2} - ${local.name3} - ${local.name5}"
}
```

### Задание 6

1. Вместо использования трёх переменных  ".._cores",".._memory",".._core_fraction" в блоке  resources {...}, объедините их в единую map-переменную **vms_resources** и  внутри неё конфиги обеих ВМ в виде вложенного map(object).  
```
 variable "vms_resources" {
  type = map(map(number))
  default = {
    vm_web = {
      cores = 2
      memory = 1
      core_fraction = 5
    },
    vm_db = {
      cores = 2
      memory = 2
      core_fraction = 20
    }
  }
}
```
3. Создайте и используйте отдельную map(object) переменную для блока metadata, она должна быть общая для всех ваших ВМ.
```
variable "metadata" {
  type = map(string)
  default = {
      ssh-keys = "ubuntu:ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIESQDdtFz+gdsBt2q+wKFNB3HiBZG0/Eftv60B6QErQD nik@sec"
      serial-port-enable = "1"
  }
  description = "VPC network & subnet name"
```  
  
5. Найдите и закоментируйте все, более не используемые переменные проекта.
6. Проверьте terraform plan. Изменений быть не должно.
![img](/img/Снимок%20экрана%202024-10-02%20113547.png)

[Весь план](/img/02/src)